{
    "level": "Info",
    "analyzer": "UnsafeDataflow",
    "op_type": "Transmute",
    "description": "Potential unsafe dataflow issue in `ssl::callbacks::raw_custom_ext_add`",
    "file": "openssl-0.10.73/src/ssl/callbacks.rs",
    "start_line": 563,
    "start_col": 1,
    "end_line": 619,
    "end_col": 2,
    "code_snippet": "pub extern \"C\" fn raw_custom_ext_add<F, T>(\n    ssl: *mut ffi::SSL,\n    _: c_uint,\n    context: c_uint,\n    out: *mut *const c_uchar,\n    outlen: *mut size_t,\n    x: *mut ffi::X509,\n    chainidx: size_t,\n    al: *mut c_int,\n    _: *mut c_void,\n) -> c_int\nwhere\n    F: Fn(&mut SslRef, ExtensionContext, Option<(usize, &X509Ref)>) -> Result<Option<T>, SslAlert>\n        + 'static\n        + Sync\n        + Send,\n    T: AsRef<[u8]> + 'static + Sync + Send,\n{\n    unsafe {\n        let ssl = SslRef::from_ptr_mut(ssl);\n        let callback = ssl\n            .ssl_context()\n            .ex_data(SslContext::cached_ex_index::<F>())\n            .expect(\"BUG: custom ext add callback missing\") as *const F;\n        let ectx = ExtensionContext::from_bits_truncate(context);\n        let cert = if ectx.contains(ExtensionContext::TLS1_3_CERTIFICATE) {\n            Some((chainidx, X509Ref::from_ptr(x)))\n        } else {\n            None\n        };\n        match (*callback)(ssl, ectx, cert) {\n            Ok(None) => 0,\n            Ok(Some(buf)) => {\n                *outlen = buf.as_ref().len();\n                *out = buf.as_ref().as_ptr();\n\n                let idx = Ssl::cached_ex_index::<CustomExtAddState<T>>();\n                let mut buf = Some(buf);\n                let new = match ssl.ex_data_mut(idx) {\n                    Some(state) => {\n                        state.0 = buf.take();\n                        false\n                    }\n                    None => true,\n                };\n                if new {\n                    ssl.set_ex_data(idx, CustomExtAddState(buf));\n                }\n                1\n            }\n            Err(alert) => {\n                *al = alert.0;\n                -1\n            }\n        }\n    }\n}"
}